<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>SALM 대시보드</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    .dashboard-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px); /* footer 제외 전체 */
    }

    .dashboard-top {
      flex: 0 0 auto;
      padding: 20px;
      text-align: center;
    }

    .dashboard-scroll-box {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 0 20px 20px 20px;
    }

    .dashboard-post-list {
      display: flex;
      flex-direction: column;
    }

    .post-card {
      background-color: #fdfaf4;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 18px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .post-card h3 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .post-card p {
      font-size: 0.95rem;
      color: #444;
      margin-bottom: 6px;
    }

    .post-card .meta {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 4px;
    }

    .read-more {
      font-size: 0.85rem;
      color: #3b3bff;
      text-decoration: underline;
    }
  </style>
  <script>
    let page = 0;
    let loading = false;
    let endOfData = false;

    async function loadPosts() {
      if (loading || endOfData) return;
      loading = true;

      try {
        const res = await fetch(`/api/posts?page=${page}`);
        const json = await res.json();

        if (!json.content || json.content.length === 0) {
          endOfData = true;
          return;
        }

        const container = document.getElementById('post-list');
        json.content.forEach(post => {
          const el = document.createElement('div');
          el.className = 'post-card';
          el.innerHTML = `
            <h3>${post.title}</h3>
            <p>${post.content && post.content.length > 100 ? post.content.substring(0, 100) + '...' : (post.content || '')}</p>
            <div class="meta">${post.author || '익명'} · ${(post.createdAt || '').replace('T', ' ').substring(0, 16)}</div>
            <a href="/post/${post.id}" class="read-more">자세히 보기</a>
          `;
          container.appendChild(el);
        });

        page += 1;
      } catch (e) {
        console.error('게시글 로딩 실패:', e);
      } finally {
        loading = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const scrollBox = document.querySelector('.dashboard-scroll-box');
      loadPosts();

      scrollBox.addEventListener('scroll', () => {
        if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 100) {
          loadPosts();
        }
      });
    });
  </script>
</head>
<body>

  <div th:replace="~{fragments/header :: common-header}"></div>

  <main class="dashboard-container">
    <section class="dashboard-top">
      <h2>살림에 대한 다양한 이야기</h2>
      <p>살림 고수들의 팁과 노하우를 나누는 공간입니다.</p>
    </section>

    <div class="dashboard-scroll-box">
      <section class="dashboard-post-list" id="post-list">
        <!-- JS가 게시글을 동적으로 삽입 -->
      </section>
    </div>
  </main>

  <div th:replace="~{fragments/footer :: common-footer}"></div>
</body>
</html>
