name: SALM Full Auto Deployment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v3

    # 2. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
    - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x ./gradlew

    # 3. ë²„ì „ ë³€ìˆ˜ ì„¤ì •
    - name: ë³€ìˆ˜ ì„¤ì • (DATE, VERSION)
      id: vars
      run: |
        echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        echo "VERSION=v1.1" >> $GITHUB_ENV  # ğŸ”¥ ì—¬ê¸° ìˆ˜ë™ ìˆ˜ì • (ë²„ì „ëª…)

    # 4. Gradle ë¹Œë“œ (bootJar)
    - name: Gradle ë¹Œë“œ
      run: ./gradlew bootJar -p ./releases/salm-${VERSION}

    # 5. ì†ŒìŠ¤ì½”ë“œ + ë¹Œë“œ ê²°ê³¼ zip ì••ì¶•
    - name: ì†ŒìŠ¤ ë° ë¹Œë“œ ê²°ê³¼ ì••ì¶• (src.zip)
      run: |
        mkdir -p package
        zip -r package/salm-${{ env.DATE }}-${{ env.VERSION }}.zip src/ build.gradle settings.gradle gradlew gradlew.bat build/libs/*.jar

    # 6. ì„œë²„ backup ë””ë ‰í† ë¦¬ì— zip ì „ì†¡
    - name: ì„œë²„ backup ë””ë ‰í† ë¦¬ì— zip íŒŒì¼ ì „ì†¡
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SALM_SERVER_HOST }}
        username: ${{ secrets.SALM_SERVER_USER }}
        key: ${{ secrets.SALM_SERVER_KEY }}
        source: "package/*.zip"
        target: "/app/salm/dev-salm/backup/"

    # 7. ì„œë²„ì—ì„œ zip ì••ì¶• í•´ì œ ë° ìë™ ë°°í¬
    - name: ì„œë²„ì—ì„œ ì••ì¶• í•´ì œ ë° ë°°í¬
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SALM_SERVER_HOST }}
        username: ${{ secrets.SALM_SERVER_USER }}
        key: ${{ secrets.SALM_SERVER_KEY }}
        script: |
          cd /app/salm/dev-salm/backup

          # ê°€ì¥ ìµœê·¼ ì—…ë¡œë“œëœ zip íŒŒì¼ ì°¾ê¸°
          ZIP_FILE=$(ls -t salm-*.zip | head -n1)
          VERSION_DIR="${ZIP_FILE%.zip}"

          # releases ë””ë ‰í† ë¦¬ì— ì••ì¶• í•´ì œ
          mkdir -p /app/salm/dev-salm/releases/$VERSION_DIR
          unzip -o $ZIP_FILE -d /app/salm/dev-salm/releases/$VERSION_DIR

          # current ì‹¬ë³¼ë¦­ ë§í¬ êµì²´
          ln -sfn /app/salm/dev-salm/releases/$VERSION_DIR /app/salm/dev-salm/current

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          pkill -f 'java.*salm' || true

          # ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
          nohup java -jar /app/salm/dev-salm/current/build/libs/*.jar > /app/salm/dev-salm/logs/salm.log 2>&1 &

          echo "âœ… SALM ${VERSION_DIR} ë²„ì „ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ"

    # 8. Slack ì•Œë¦¼ (ë¹Œë“œ ì„±ê³µ)
    - name: Slack ì•Œë¦¼ (ë¹Œë“œ ì„±ê³µ)
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"text\": \"âœ… SALM ë¹Œë“œ ë° ë°°í¬ ì„±ê³µ!\n- ë²„ì „: ${{ env.DATE }}-${{ env.VERSION }}\n- ë¸Œëœì¹˜: ${{ github.ref_name }}\n- ì»¤ë°‹: ${{ github.event.head_commit.message }}\n- ì‘ì„±ì: ${{ github.event.head_commit.author.name }}\" 
        }" ${{ secrets.SLACK_WEBHOOK_URL }}

    # 9. Slack ì•Œë¦¼ (ë¹Œë“œ ì‹¤íŒ¨)
    - name: Slack ì•Œë¦¼ (ë¹Œë“œ ì‹¤íŒ¨)
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"text\": \"âŒ SALM ë¹Œë“œ ì‹¤íŒ¨!\n- ë²„ì „: ${{ env.DATE }}-${{ env.VERSION }}\n- ë¸Œëœì¹˜: ${{ github.ref_name }}\n- ì»¤ë°‹: ${{ github.event.head_commit.message }}\n- ì‘ì„±ì: ${{ github.event.head_commit.author.name }}\" 
        }" ${{ secrets.SLACK_WEBHOOK_URL }}

    # 10. GitHub íƒœê·¸ ì¶”ê°€
    - name: GitHub íƒœê·¸ ì¶”ê°€
      if: success()
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git tag "${{ env.DATE }}-${{ env.VERSION }}"
        git push origin "${{ env.DATE }}-${{ env.VERSION }}"

