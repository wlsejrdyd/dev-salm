name: SALM Full CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v3

    - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x ./gradlew

    - name: Gradle ë¹Œë“œ (bootJar)
      run: ./gradlew bootJar

    - name: ë³€ìˆ˜ ì„¤ì • (DATE, VERSION)
      id: vars
      run: |
        echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        echo "VERSION=v1.1" >> $GITHUB_ENV  # ðŸ”¥ ì—¬ê¸°ë§Œ ìˆ˜ë™ ìˆ˜ì •

    - name: Slack ì•Œë¦¼ (ë¹Œë“œ ì„±ê³µ)
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"text\": \"âœ… SALM ë¹Œë“œ ì„±ê³µ!\n- ë²„ì „: ${DATE}-${VERSION}\n- ë¸Œëžœì¹˜: ${{ github.ref_name }}\n- ì»¤ë°‹: ${{ github.event.head_commit.message }}\n- ìž‘ì„±ìž: ${{ github.event.head_commit.author.name }}\"
        }" ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Slack ì•Œë¦¼ (ë¹Œë“œ ì‹¤íŒ¨)
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"text\": \"âŒ SALM ë¹Œë“œ ì‹¤íŒ¨!\n- ë²„ì „: ${DATE}-${VERSION}\n- ë¸Œëžœì¹˜: ${{ github.ref_name }}\n- ì»¤ë°‹: ${{ github.event.head_commit.message }}\n- ìž‘ì„±ìž: ${{ github.event.head_commit.author.name }}\"
        }" ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: ì„œë²„ì— .jar íŒŒì¼ ë³µì‚¬
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SALM_SERVER_HOST }}
        username: ${{ secrets.SALM_SERVER_USER }}
        key: ${{ secrets.SALM_SERVER_KEY }}
        source: "build/libs/*.jar"
        target: "/app/salm/dev-salm/releases/salm-${{ env.DATE }}-${{ env.VERSION }}"

    - name: ì„œë²„ì—ì„œ ë°°í¬ ë° ë°±ì—…
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SALM_SERVER_HOST }}
        username: ${{ secrets.SALM_SERVER_USER }}
        key: ${{ secrets.SALM_SERVER_KEY }}
        script: |
          # ì‹¬ë³¼ë¦­ ë§í¬ ë³€ê²½
          ln -sfn /app/salm/dev-salm/releases/salm-${{ env.DATE }}-${{ env.VERSION }} /app/salm/dev-salm/current

          # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /app/salm/dev-salm/backup

          # .jar íŒŒì¼ ë°±ì—…
          cp /app/salm/dev-salm/current/*.jar /app/salm/dev-salm/backup/salm-${{ env.DATE }}-${{ env.VERSION }}.jar

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          pkill -f 'java.*salm' || true

          # ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
          nohup java -jar /app/salm/dev-salm/current/*.jar > /app/salm/dev-salm/logs/salm.log 2>&1 &

          echo "âœ… SALM ${DATE}-${VERSION} ë²„ì „ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì™„ë£Œ"

    - name: GitHub íƒœê·¸ ì¶”ê°€
      if: success()
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git tag "${{ env.DATE }}-${{ env.VERSION }}"
        git push origin "${{ env.DATE }}-${{ env.VERSION }}"

